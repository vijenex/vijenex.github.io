name: Auto-Publish Blog

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  publish:
    if: github.event.label.name == 'publish'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Extract metadata
        id: meta
        run: |
          TITLE="$(echo '${{ github.event.issue.title }}' | sed 's/\[BLOG\] //')"
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          DATE=$(date '+%b %d, %Y')
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Create blog post
        run: |
          cat > blog/${{ steps.meta.outputs.slug }}.html << 'ENDFILE'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <title>${{ steps.meta.outputs.title }} ‚Äî Vijenex‚Ñ¢ Blog</title>
            <link rel="icon" href="../assets/logo-icon.png" />
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="../assets/style.css" />
            <link rel="stylesheet" href="../assets/blog.css" />
          </head>
          <body class="theme-dark">
            <header class="topbar">
              <div class="inner">
                <a class="brand" href="/">
                  <img src="../assets/logo-icon.png" alt="Vijenex" class="logo-icon">
                  <span class="brand-text">Vijenex<sup>‚Ñ¢</sup></span>
                </a>
                <nav class="nav">
                  <a href="/#tools">Tools</a>
                  <a href="/#integrations">Integrations</a>
                  <a href="/blog/">Blog</a>
                  <a href="/#contribute">Contribute</a>
                  <a class="btn small" href="https://github.com/vijenex">GitHub</a>
                  <button id="themeToggle" class="theme-btn">‚òÄÔ∏è</button>
                </nav>
              </div>
            </header>
            <article class="blog-post">
              <h1>${{ steps.meta.outputs.title }}</h1>
              <div class="blog-meta">
                <span class="blog-tag">Cloud Security</span>
                <span>üìÖ ${{ steps.meta.outputs.date }}</span>
                <span>üë§ @${{ github.event.issue.user.login }}</span>
              </div>
              <div class="blog-content">
          ENDFILE
          
          echo '${{ github.event.issue.body }}' | sed 's/</\&lt;/g; s/>/\&gt;/g; s/^/<p>/; s/$/<\/p>/' >> blog/${{ steps.meta.outputs.slug }}.html
          
          cat >> blog/${{ steps.meta.outputs.slug }}.html << 'ENDFILE'
                <div class="author-box">
                  <h3>About the Author</h3>
                  <p><strong>@${{ github.event.issue.user.login }}</strong></p>
                </div>
              </div>
            </article>
            <footer class="site-footer">
              <div class="container">
                <div class="footer-bottom">
                  <p>¬© 2025 Vijenex‚Ñ¢. <a href="/blog/">‚Üê Back</a></p>
                </div>
              </div>
            </footer>
            <script src="../assets/script.js"></script>
          </body>
          </html>
          ENDFILE
      
      - name: Update index
        run: |
          EXCERPT=$(echo '${{ github.event.issue.body }}' | head -c 150 | tr '\n' ' ')
          sed -i "/<div class=\"blog-grid\">/a\    <article class=\"blog-card\">\n      <div class=\"blog-card-content\">\n        <div class=\"blog-meta\">\n          <span class=\"blog-tag\">Cloud Security</span>\n          <span>${{ steps.meta.outputs.date }}</span>\n        </div>\n        <h3><a href=\"${{ steps.meta.outputs.slug }}.html\">${{ steps.meta.outputs.title }}</a></h3>\n        <p class=\"blog-excerpt\">${EXCERPT}...</p>\n        <a href=\"${{ steps.meta.outputs.slug }}.html\" class=\"read-more\">Read more ‚Üí</a>\n      </div>\n    </article>" blog/index.html
      
      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blog/
          git commit -m "Publish: ${{ steps.meta.outputs.title }}

          Closes #${{ github.event.issue.number }}"
          git push
      
      - name: Close issue
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Published at https://vijenex.github.io/blog/${{ steps.meta.outputs.slug }}.html'
            });
